{
  "dpo_v2": {
    "model": "DPO v2",
    "timestamp": "2025-12-31T21:05:14.281572",
    "total_questions": 15,
    "overall_score": 0.37722222222222224,
    "category_scores": {
      "complex_sql": 0.41785714285714287,
      "business_logic": 0.35238095238095235,
      "cross_module_join": 0.5357142857142857,
      "hallucination": 0.1
    },
    "results": [
      {
        "id": "complex_sql_001",
        "category": "complex_sql",
        "question": "Write SQL to calculate AR aging buckets (30/60/90+ days) for unpaid invoices by customer",
        "ground_truth": "Key tables: ARTH (AR Transaction Header), ARCM (AR Customer Master). Use DATEDIFF with TransDate, filter PayFullDate IS NULL for unpaid. GROUP BY CustGroup, Customer with CASE WHEN for aging buckets.",
        "model_response": "```sql\nSELECT ARCo, CustGroup, Customer, InvNum, InvDate, Amount,\n  DATEDIFF(day, InvDate, GETDATE()) AS DaysOld,\n  CASE WHEN DATEDIFF(day, InvDate, GETDATE()) <= 30 THEN '0-30'\n        WHEN DATEDIFF(day, InvDate, GETDATE()) BETWEEN 31 AND 60 THEN '31-60'\n        WHEN DATEDIFF(day, InvDate, GETDATE()) > 60 THEN '61+'\n        ELSE 'Other' END AS AgingBucket\nFROM ARTH WITH (NOLOCK)\nWHERE ARCo = @ARCo AND Status = 0\nGROUP BY ARCo, CustGroup, Customer, InvNum, InvDate\nORDER BY Customer\n```\n\nNote: WITH (NOLOCK) prevents blocking production transactions. Always filter by company column.",
        "element_score": 0.7142857142857143,
        "elements_found": [
          "ARTH",
          "DATEDIFF",
          "CASE WHEN",
          "CustGroup",
          "Customer"
        ],
        "elements_missing": [
          "ARCM",
          "PayFullDate IS NULL"
        ],
        "forbidden_found": [],
        "is_refusal": false,
        "should_refuse": false,
        "refusal_appropriate": true,
        "final_score": 0.7142857142857143
      },
      {
        "id": "complex_sql_002",
        "category": "complex_sql",
        "question": "Write SQL to get subcontractor costs with original, change orders, invoiced, paid, and retainage by vendor",
        "ground_truth": "Key tables: SLHD (SL Header), SLIT (SL Item), APVM (Vendor Master). Join on SLCo/SL and VendorGroup/Vendor. Sum OrigCost, CurCost-OrigCost for changes, InvCost, Retainage. GROUP BY vendor.",
        "model_response": "```sql\nSELECT SLHD.SLCo, SLHD.Vendor, SLHD.SL,\n  SLIT.CurCost + SLIT.ChgCost AS OriginalCost,\n  SLIT.InvCost + SLIT.PaidCost AS InvoicedCost,\n  SLIT.PaidCost - SLIT.InvCost AS PaidCost,\n  SLIT.Retainage,\n  SLIT.ChgCost\nFROM SLHD WITH (NOLOCK)\nINNER JOIN SLIT WITH (NOLOCK)\n  ON SLHD.SLCo = SLIT.SLCo AND SLHD.SL = SLIT.SL\nWHERE SLHD.SLCo = @SLCo\nORDER BY SLIT.SL\n```\n\nNote: WITH (NOLOCK) prevents blocking production transactions. Always filter by company column.",
        "element_score": 0.625,
        "elements_found": [
          "SLHD",
          "SLIT",
          "CurCost",
          "InvCost",
          "Retainage"
        ],
        "elements_missing": [
          "APVM",
          "OrigCost",
          "VendorGroup"
        ],
        "forbidden_found": [],
        "is_refusal": false,
        "should_refuse": false,
        "refusal_appropriate": true,
        "final_score": 0.625
      },
      {
        "id": "complex_sql_003",
        "category": "complex_sql",
        "question": "Write SQL to aggregate job cost estimates by phase and cost type with item vs phase unit distinctions",
        "ground_truth": "Key tables: JCJP (Job Phase), JCCH (Cost Header), JCCP (Cost Phase), JCCT (Cost Type). Use ItemUnitFlag/PhaseUnitFlag from JCCH to determine unit type. Sum OrigEstCost, CurrEstCost, CurrEstHours.",
        "model_response": "```sql\nSELECT JCCD.JCCo, JCCD.Job, JCCD.PhaseGroup, JCCD.Phase, JCCD.CostType,\n  SUM(JCCD.EstCost) AS Budget, SUM(JCCD.EstUnits) AS EstUnits,\n  SUM(JCCD.ActualCost) AS Actual, SUM(JCCD.ActualUnits) AS ActualUnits,\n  SUM(JCCD.ProjCost) AS ProjCost, SUM(JCCD.RemainCmtdCost) AS RemainCmtdCost,\n  SUM(JCCD.TotalCmtdCost) AS TotalCmtdCost,\n  CASE WHEN SUM(JCCD.PhaseUnitFlag) = 0 THEN 'Phase' ELSE 'Cost Type' END AS UnitFlag\nFROM JCCD WITH (NOLOCK)\nWHERE JCCD.Source = 'PM Cost Entry'\nGROUP BY JCCD.JCCo, JCCD.Job, JCCD.PhaseGroup, JCCD.Phase, JCCD.CostType\nORDER BY JCCD.JCCo, JCCD.Job, JCCD.Phase, JCCD.CostType\n```\n\nNote: Always use WITH (NOLOCK) for SELECT queries and filter by company column.",
        "element_score": 0.125,
        "elements_found": [
          "PhaseUnitFlag"
        ],
        "elements_missing": [
          "JCJP",
          "JCCH",
          "JCCP",
          "JCCT",
          "ItemUnitFlag",
          "OrigEstCost",
          "CurrEstCost"
        ],
        "forbidden_found": [],
        "is_refusal": false,
        "should_refuse": false,
        "refusal_appropriate": true,
        "final_score": 0.125
      },
      {
        "id": "complex_sql_004",
        "category": "complex_sql",
        "question": "Write SQL to track AP hold status distinguishing retainage vs non-retainage holds",
        "ground_truth": "Key tables: APTD (AP Trans Detail), APHD (AP Hold Detail), APCO (AP Company). Check HoldCode against APCO.RetHoldCode. If match = retainage hold, else = non-retainage hold.",
        "model_response": "```sql\nSELECT APTH.APCo, APTH.Vendor, APTH.Mth, APTH.APTrans,\n  CASE WHEN APTD.PayType = 'R' THEN APTD.Amount ELSE 0 END AS RetainageHold,\n  CASE WHEN APTD.PayType <> 'R' THEN APTD.Amount ELSE 0 END AS NonRetainageHold\nFROM APTH WITH (NOLOCK)\nINNER JOIN APTD WITH (NOLOCK)\n  ON APTH.APCo = APTD.APCo AND APTH.Mth = APTD.Mth AND APTH.APTrans = APTD.APTrans\nWHERE APTH.APCo = @APCo AND APTH.Status = 1\n```\n\nNote: Always use WITH (NOLOCK) for SELECT queries and filter by company column.",
        "element_score": 0.5,
        "elements_found": [
          "APTD",
          "APCO",
          "PayType"
        ],
        "elements_missing": [
          "APHD",
          "RetHoldCode",
          "HoldCode"
        ],
        "forbidden_found": [],
        "is_refusal": false,
        "should_refuse": false,
        "refusal_appropriate": true,
        "final_score": 0.5
      },
      {
        "id": "complex_sql_005",
        "category": "complex_sql",
        "question": "Write SQL to reconcile AP oncost batch lines with original transactions",
        "ground_truth": "Key tables: APLB (AP Line Batch), APHB (AP Header Batch), APTL (AP Trans Line), APTH (AP Trans Header), APVM. Join on ocApplyMth, ocApplyTrans, ocApplyLine to link oncost to original.",
        "model_response": "-- =====================================================================================\n-- AP On-Cost RECONCILIATION Query\n-- =====================================================================================\n-- Purpose: Reconcile AP oncost batch lines with original transactions\n-- Author: Viewpoint SQL Expert\n-- Date: 2025-10-10\n-- =====================================================================================\n\nWITH AP_Ontco AS (\n    -- Aggregate AP On-Cost transactions by Month and AP Transaction\n    Select \n        APTH.APCo as Company,\n        APTH.Mth as TransactionMonth,\n        APTH.APTrans as APTransaction,\n        SUM(APTH.Amount) as TotalAmount,\n        SUM(APTH.VATtaxAmt) as TotalVATTax,\n        SUM(APTH.GSTtaxAmt) as TotalGSTTax,\n        COUNT(DISTINCT APTH.APLine) as LineCount\n    From dbo.APTH WITH (NOLOCK)\n    WHERE APTH.PayType IN ('O', 'P')  -- On-Cost pay types\n      AND APTH.Status IN (0, 1)     -- Unpaid or partially paid\n    GROUP BY APTH.APCo, APTH.Mth, APTH.APTrans\n),\n\nAP_Orig AS (\n    -- Aggregate Original AP transactions by Month and AP Transaction\n    Select \n        APTH.APCo as Company,\n        APTH.Mth as TransactionMonth,\n        APTH.APTrans as APTransaction,\n        SUM(APTH.Amount) as TotalAmount,\n        SUM(APTH.VATtaxAmt) as TotalVATTax,\n        SUM(APTH.GSTtaxAmt) as TotalGSTTax,\n        COUNT(*) as TransactionCount\n    From dbo.APTH WITH (NOLOCK)\n    WHERE APTH.Status IN (0, 1)     -- Unpaid or partially paid\n    GROUP BY APTH.APCo, APTH.Mth, APTH.APTrans\n)\n\n-- =====================================================================================\n-- RECONCILIATION Results\n-- =====================================================================================\nSelect \n    'AP_ONCOST_RECONCILIATION' as ReportType,\n    AP_Ontco.Company,\n    AP_Ontco.TransactionMonth,\n    AP_Ontco.APTransaction,\n    AP_Ontco.TotalAmount as AP_Total,\n    AP_Ontco.VATTax as AP_VAT_Tax,\n    AP_Ontco.GSTTax as AP_GST_Tax,\n    AP_Orig.TotalAmount as Original_Total,\n    AP_Orig.VATTax as Original_VAT_Tax,\n    AP_Orig.GSTTax as Original_GST_Tax,\n",
        "element_score": 0.125,
        "elements_found": [
          "APTH"
        ],
        "elements_missing": [
          "APLB",
          "APHB",
          "APTL",
          "APVM",
          "ocApplyMth",
          "ocApplyTrans",
          "ocApplyLine"
        ],
        "forbidden_found": [],
        "is_refusal": false,
        "should_refuse": false,
        "refusal_appropriate": true,
        "final_score": 0.125
      },
      {
        "id": "complex_biz_001",
        "category": "business_logic",
        "question": "How does Vista calculate maximum retainage when InclACOinMaxYN is set to Y?",
        "ground_truth": "When InclACOinMaxYN='Y', Vista includes Approved Change Orders in max retainage: MaxRetgPct * CurCost. When 'N', uses OrigCost only. Found in SLHB/SLCO settings.",
        "model_response": "When InclACOinMaxYN is 'Y', the system includes the ACO in the calculation of maximum retainage for a specific job and contract. It retrieves the relevant contract from the job master (JCJM), fetches the maximum retainage percentage from the company setup (HQCO) and job retainage override (JCRM), and computes the max retainage as the sum of previous retainage plus a new percentage on qualifying costs. This ensures retainage limits are more inclusive across job phases and cost types.\n\n---",
        "element_score": 0.3333333333333333,
        "elements_found": [
          "InclACOinMaxYN",
          "ACO"
        ],
        "elements_missing": [
          "MaxRetgPct",
          "CurCost",
          "OrigCost",
          "SLHB"
        ],
        "forbidden_found": [],
        "is_refusal": false,
        "should_refuse": false,
        "refusal_appropriate": true,
        "final_score": 0.3333333333333333
      },
      {
        "id": "complex_biz_002",
        "category": "business_logic",
        "question": "What is the difference between WCRetAmt and SMRetAmt in subcontract worksheets?",
        "ground_truth": "WCRetAmt = Work Completed Retainage (labor/work in place). SMRetAmt = Stored Materials Retainage. Both in SLWI table. Total retainage = WCRetAmt + SMRetAmt.",
        "model_response": "The difference between WCRetAmt and SMRetAmt is: 0",
        "element_score": 0.4,
        "elements_found": [
          "WCRetAmt",
          "SMRetAmt"
        ],
        "elements_missing": [
          "SLWI",
          "Work Completed",
          "Stored Materials"
        ],
        "forbidden_found": [],
        "is_refusal": false,
        "should_refuse": false,
        "refusal_appropriate": true,
        "final_score": 0.4
      },
      {
        "id": "complex_biz_003",
        "category": "business_logic",
        "question": "How do I determine if an AP invoice is on hold for retainage vs non-retainage reasons?",
        "ground_truth": "Check APHD.HoldCode against APCO.RetHoldCode. If HoldCode = RetHoldCode, it is a retainage hold. Otherwise non-retainage hold.",
        "model_response": "To check the hold status of an AP invoice for retainage or non-retainage reasons:\n\n```sql\nSELECT APCo, Mth, APTrans, HoldCode\nFROM APTH WITH (NOLOCK)\nWHERE APCo = @APCo AND Mth = @Mth AND APTrans = @APTrans\n```\n\nIf `HoldCode` is not null and matches your company's retainage hold code (from bAPCO), it's on hold for retainage. Otherwise, it's not.",
        "element_score": 0.6,
        "elements_found": [
          "APCO",
          "HoldCode",
          "retainage hold"
        ],
        "elements_missing": [
          "APHD",
          "RetHoldCode"
        ],
        "forbidden_found": [],
        "is_refusal": false,
        "should_refuse": false,
        "refusal_appropriate": true,
        "final_score": 0.6
      },
      {
        "id": "complex_biz_004",
        "category": "business_logic",
        "question": "Explain how stored materials (Purchased - Installed) affects SL billing",
        "ground_truth": "In SLWI: StoredMatls = Purchased - Installed. Materials on-site but not used. Billed separately from WCCost. Total billable = WCCost + StoredMatls. Different retainage rates (SMRetPct vs WCRetPct).",
        "model_response": "When stored materials (Purchased - Installed) are used in service work completed transactions, the associated costs may be billed to customers based on configured cost types and job settings. The billing process checks transaction details like work orders, scopes, cost types, and flags (e.g., AP/MS interfaced, job invoiced) to determine if and how to apply stored material costs. If conditions are met, it creates or updates AP invoices, GL entries, or JC billings for accurate financial tracking in construction service operations.",
        "element_score": 0.2857142857142857,
        "elements_found": [
          "Purchased",
          "Installed"
        ],
        "elements_missing": [
          "SLWI",
          "StoredMatls",
          "WCCost",
          "SMRetPct",
          "WCRetPct"
        ],
        "forbidden_found": [],
        "is_refusal": false,
        "should_refuse": false,
        "refusal_appropriate": true,
        "final_score": 0.2857142857142857
      },
      {
        "id": "complex_biz_005",
        "category": "business_logic",
        "question": "What tables are involved in cost-to-complete projections for jobs?",
        "ground_truth": "Key tables: JCPR (Projection Resources), JCPD (Projection Detail), JCCP (Cost Phase for estimates), JCCD (Cost Detail for actuals). Compare CurrEstCost vs ActualCost.",
        "model_response": "- `JCCH` - JC Cost Header\n- `JCCP` - JC Cost By Period\n- `JCJP` - JC Job Phases\n\n---",
        "element_score": 0.14285714285714285,
        "elements_found": [
          "JCCP"
        ],
        "elements_missing": [
          "JCPR",
          "JCPD",
          "JCCD",
          "CurrEstCost",
          "ActualCost",
          "projection"
        ],
        "forbidden_found": [],
        "is_refusal": false,
        "should_refuse": false,
        "refusal_appropriate": true,
        "final_score": 0.14285714285714285
      },
      {
        "id": "complex_join_001",
        "category": "cross_module_join",
        "question": "How do I join SLWI retainage amounts to matching APTD transactions?",
        "ground_truth": "Join path: SLWI -> APTL (on SLCo=APCo, SL, SLItem) -> APTD (on APCo, Mth, APTrans, APLine). Filter APTD.PayType = APCO.RetPayType for retainage.",
        "model_response": "To correctly join retainage amounts to APTD, you must include all key columns:\n\n```sql\nSELECT *\nFROM SLWI WITH (NOLOCK)\nINNER JOIN APTD WITH (NOLOCK)\n  ON SLWI.APCo = APTD.APCo AND SLWI.Mth = APTD.Mth AND SLWI.APTrans = APTD.APTrans\n```\n\nIncomplete JOIN like `SLWI.Retainage = APTD.Retainage` would be incorrect because: Missing APCo in JOIN.",
        "element_score": 0.5714285714285714,
        "elements_found": [
          "SLWI",
          "APTD",
          "APCO",
          "SL"
        ],
        "elements_missing": [
          "APTL",
          "RetPayType",
          "SLItem"
        ],
        "forbidden_found": [],
        "is_refusal": false,
        "should_refuse": false,
        "refusal_appropriate": true,
        "final_score": 0.5714285714285714
      },
      {
        "id": "complex_join_002",
        "category": "cross_module_join",
        "question": "What is the relationship between JCJP (Job Phase) and JCCP (Cost Code Phase)?",
        "ground_truth": "JCJP = Job/Contract Phase (billing). JCCP = Cost Code Phase (cost tracking). Join on JCCo, Job, PhaseGroup, Phase. JCJP links to JCJI. JCCP links to JCCH for cost types.",
        "model_response": "The relationship between JCJP and JCCP is: JCCP is the cost detail for JCJP.\n\n**Key tables:**\n- JCJP (JC Job Phases)\n- JCCP (JC Cost By Period)\n\n**Usage example:**\n```sql\nSELECT JCJP.*, JCCP.*\nFROM JCJP WITH (NOLOCK)\nINNER JOIN JCCP WITH (NOLOCK)\n  ON JCJP.JCCo = JCCP.JCCo AND JCJP.Job = JCCP.Job AND JCJP.PhaseGroup = JCCP.PhaseGroup AND JCJP.Phase = JCCP.Phase\n```\n\nAlways use WITH (NOLOCK) for SELECT queries to prevent blocking.",
        "element_score": 0.75,
        "elements_found": [
          "JCJP",
          "JCCP",
          "JCCo",
          "Job",
          "PhaseGroup",
          "Phase"
        ],
        "elements_missing": [
          "JCCH",
          "JCJI"
        ],
        "forbidden_found": [],
        "is_refusal": false,
        "should_refuse": false,
        "refusal_appropriate": true,
        "final_score": 0.75
      },
      {
        "id": "complex_join_003",
        "category": "cross_module_join",
        "question": "How do I link SM WorkOrder to AR billing through JC contracts?",
        "ground_truth": "Path: SMWorkOrder -> SMServiceSite (ServiceSite) -> JCJM (Job) -> JCCM (Contract) -> ARTH for billing. Or direct via SMWorkOrderInvoice.",
        "model_response": "To link SM WorkOrder to AR billing through JC contracts:\n\n1. **Identify the associated JC contract in SM Contract (vSMContract) for the given SMCo and WorkOrder.**\n2. **Find the AR customer record in AR Customer Master (bARCM) that matches the contract's customer group and customer number.**\n3. **Use the customer ID from the AR customer record to proceed with billing linkage.**\n\n```sql\nSELECT DISTINCT s.*\nFROM SMWorkOrder WITH (NOLOCK)\nINNER JOIN vSMContract WITH (NOLOCK)\n    ON SMWorkOrder.SMCo = vSMContract.SMCo AND SMWorkOrder.Contract = vSMContract.Contract\nINNER JOIN bARCM WITH (NOLOCK)\n    ON vSMContract.CustGroup = bARCM.CustGroup AND vSMContract.Customer = bARCM.Customer\nWHERE SMWorkOrder.SMCo = @SMCo AND SMWorkOrder.WorkOrder = @WorkOrder\n```\n\nNote: Always use WITH (NOLOCK) for SELECT queries and filter by company column.",
        "element_score": 0.2857142857142857,
        "elements_found": [
          "SMWorkOrder",
          "Contract"
        ],
        "elements_missing": [
          "SMServiceSite",
          "JCJM",
          "JCCM",
          "ARTH",
          "Job"
        ],
        "forbidden_found": [],
        "is_refusal": false,
        "should_refuse": false,
        "refusal_appropriate": true,
        "final_score": 0.2857142857142857
      },
      {
        "id": "complex_halluc_001",
        "category": "hallucination",
        "question": "What columns are in the ARAgingReport table?",
        "ground_truth": "REJECT - ARAgingReport does not exist in Viewpoint Vista. Use VPShared_CustomerAging view or query ARTH/ARTL directly.",
        "model_response": "There is no table or view named 'ARAgeingReport' in Viewpoint Vista. The database uses module-prefixed names like APTH (AP Transaction Header) or JCJM (JC Job Master).",
        "element_score": 0.0,
        "elements_found": [],
        "elements_missing": [
          "does not exist",
          "not a real table",
          "ARTH",
          "VPShared_CustomerAging"
        ],
        "forbidden_found": [],
        "is_refusal": false,
        "should_refuse": true,
        "refusal_appropriate": false,
        "final_score": 0
      },
      {
        "id": "complex_halluc_002",
        "category": "hallucination",
        "question": "Write SQL to query the SubcontractorPayments table",
        "ground_truth": "REJECT - SubcontractorPayments does not exist. Use APTD linked to APTL with SL reference, or SLWI for worksheet tracking.",
        "model_response": "I cannot write a query for 'SubcontractorPayments' because this table does not exist in Viewpoint Vista.\n\nPlease specify the correct Viewpoint table name.",
        "element_score": 0.2,
        "elements_found": [
          "does not exist"
        ],
        "elements_missing": [
          "not a real table",
          "APTD",
          "APTL",
          "SLWI"
        ],
        "forbidden_found": [],
        "is_refusal": true,
        "should_refuse": true,
        "refusal_appropriate": true,
        "final_score": 0.2
      }
    ]
  },
  "sft": null
}